{"componentChunkName":"component---src-pauliescanlon-gatsby-theme-terminal-layouts-source-layout-js","path":"/posts/2022/12/08-from-million-to-thousand-requests-with-correct-caching/","result":{"data":{"mdx":{"id":"9c69f02d-290b-5317-8fa0-a052a99c39bc","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"From a million to a thousand requests with correct caching\",\n  \"date\": \"2022-12-10T00:00:00.000Z\",\n  \"dateModified\": \"2022-12-10T00:00:00.000Z\",\n  \"author\": \"Vinícius Lourenço\",\n  \"tags\": [\"AWS\", \"SQS\", \"Cloudfront\", \"Lambda\", \"NestJS\", \"Fastify\"],\n  \"featuredImage\": \"08-from-million-to-thousand-requests-with-correct-caching.jpg\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component '\" + name + \"' was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#the-results\"\n  }), \"First, the results\")), mdx(\"p\", null, \"A journey about how I went from this amount of invocations in a voting system:\"), mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/lambda_v1.jpg\",\n    alt: \"The amount of invocations in v1.\"\n  }), mdx(\"p\", null, \"To this number of invocations, doing 2x more requests than v1 metrics but only processing a fraction of it:\"), mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/lambda_v2.jpg\",\n    alt: \"The amount of invocations in v2.\"\n  }), mdx(\"p\", null, \"If you don't like reading images, don't worry, I have a table:\"), mdx(\"table\", null, mdx(\"thead\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"thead\"\n  }, mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Version\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Votes\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Invocations (peak)\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Lambda Concurrency (peak)\"))), mdx(\"tbody\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"v1\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"280k\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"1,51 million\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"200\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"v2\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"700k\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"1,6 thousand\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"11\")))), mdx(\"p\", null, \"Well, I can say definitly is a blazing fast improvement, right?\"), mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/fast-blazing-fast.gif\",\n    alt: \"Brazing fast, as The Primegean says.\"\n  }), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#context\"\n  }), \"Ok, context please?\")), mdx(\"p\", null, \"Okay, the following task came to me in a sunday morning:\"), mdx(\"div\", {\n    style: {\n      backgroundColor: '#FFF',\n      width: '100%'\n    }\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/context.png\",\n    alt: \"The conversation between me and my manager.\"\n  })), mdx(\"p\", null, \"With these requirements, let's present the first architecture I design.\"), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#v1-architecture\"\n  }), \"v1 Architecture\")), mdx(\"p\", null, \"About the technologies, I choose:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"NestJS with Fastify.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"For performance, I leave as little middleware as possible, I even remove \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"compression\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"rate-limit\"), \" to not cost too much in the performance.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Stateless JWTs to authenticate.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Usually, I prefer to hit the database every request to check if the JWT is still valid, in this case, I skip this part and keep the JWT expire time as low as possible.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"AWS Lambda\"), \" to host the code.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The advantage of using this guy is I can pay only the usage, and the TV Show only runs once in the week, so this guys fits very well.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"AWS API Gateway HTTP\"), \" to expose the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"AWS Lambda\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Using \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"HTTP\"), \" version instead \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"REST\"), \" makes me reduce costs, instead paying $4 per million, I only pay $1.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"AWS ElastiCache\"), \" to cache every data to reduce database workload in hot-paths.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"I choose a cluster with 2 instances of 0,5GB, I will not save too much information but I need to have high read capacity.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"AWS RDS Postgres\"), \" as the database service.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"For this guy, I knew it I will not use so much, so I choose just a T4g.small with 2vCPU with 2GB RAM.\")), mdx(\"p\", null, \"The architecture looks like:\"), mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/v1_architecture.jpg\",\n    alt: \"The v1 architecture.\"\n  }), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Fun fact: I cost around $70 without any API call.\")), mdx(\"h3\", null, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#why-x-not-y\"\n  }), \"But wait, why dind't you choose X instead Y?\")), mdx(\"p\", null, \"At this point, you can think about why I didn't use NoSQL database, or host in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS EC2\"), \", or use another technology.\"), mdx(\"p\", null, \"My answer to this is just: I had 2 weeks to build a system, test and deploy it to be used by the TV Show.\"), mdx(\"p\", null, \"Also, I will explain further, it almost have no difference the technology I choose for the database, to host the API, the main bottlenecks of my application\\nis not in those areas.\"), mdx(\"p\", null, \"Choose technologies that your team is confortable and you know, if you have more time you can explore and test new things but with little time,\\ngo with technologies that you already deployed in production and these was the technologies that I knew it in that time.\"), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#hot-path\"\n  }), \"The hot path of V1\")), mdx(\"p\", null, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Hot Path\"), \" is the area of your code that is more accessed, in my case, was two routes:\"), mdx(\"h3\", null, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#get-polls\"\n  }), \"GET: \", mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"/polls\"))), mdx(\"p\", null, \"This route return the current polls to the users see which singer currently can be voted.\"), mdx(\"p\", null, \"To have better performance and to not hit the database everytime, I cache this data inside \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ElastiCache\"), \",\\nso everytime someone ask to the open polls, I return this data that was cached by 3s.\"), mdx(\"p\", null, \"This cache relys on the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS Lambda\"), \", inside \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"NestJS\"), \" service that deals with the request of getting the polls.\\nRemeber this information, I will talk about it again in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"V2\"), \" architecture.\"), mdx(\"p\", null, \"Also, this route was called every 3s by the users because we need to check if the poll still available,\\nthe administrators could enable and disbled whetever time they want.\"), mdx(\"h3\", null, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#post-polls\"\n  }), \"POST: \", mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"/polls/{pollId}/signers/{signerId}\"))), mdx(\"p\", null, \"In this route, the users could select which singer they want. And because the user can call this route as many times they want,\\nthis route is insanely called.\"), mdx(\"p\", null, \"To reduce the stress in the database, I only make 1 database call in this route, is the insert to save the vote.\\nTo count the amount of votes, I leave this task to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ElastiCache\"), \" and I use this insanely well designed library called \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/mlomb/redis-rank\"\n  }), \"redis-rank\"), \".\\nWith this library, I could make a rank for each poll easily and insert the votes one by one as soon it reaches.\"), mdx(\"p\", null, \"To check if the vote is valid, I cache the information in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ElastiCache\"), \" and I just look up to it. With this strategy, I could save 2 database calls, one\\nfor \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"pollId\"), \" and another for \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"signerId\"), \".\"), mdx(\"p\", null, \"Also, I didn't use foreign keys in the database that saves the votes because I didn't want the database to make the job I already was doing of checking if the information\\nis valid, in this table, I only leave an \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"index\"), \" in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"pollId\"), \" to be able to count and compare the votes once the poll ends to check if everything is sincronized.\"), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#v1-metrics\"\n  }), \"The metrics of V1\")), mdx(\"p\", null, \"At this point, I was very proud of what I could achieve because I deploy this solution and it works very well.\"), mdx(\"p\", null, \"Now, let's see the metrics for 280k votes did by 12k users:\"), mdx(\"a\", {\n    href: \"/images/posts/2022/12/08/lambda_v1.png\",\n    target: \"_blank\"\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/lambda_v1.jpg\",\n    alt: \"The amount of invocations in v1.\"\n  })), mdx(\"p\", null, \"Also, I have some metrics from the database too:\"), mdx(\"a\", {\n    href: \"/images/posts/2022/12/08/cpu_v1.png\",\n    target: \"_blank\"\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/cpu_v1.png\",\n    alt: \"The database CPU usage.\"\n  })), mdx(\"a\", {\n    href: \"/images/posts/2022/12/08/commits_v1.png\",\n    target: \"_blank\"\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/commits_v1.png\",\n    alt: \"The database commits.\"\n  })), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Hint: Click in the image to open in higher resolution.\")), mdx(\"p\", null, \"The system was very stressed but it handle very well (no errors).\\nThe CPU usage was high but is burstable, so it could pass 2 vCPU without worries so these amount of usage is not a problem.\"), mdx(\"p\", null, \"The only thing I didn't like is the amount of concurrency in lambdas and the amount of commits per second, the database was doing like 400 commits per second, is ALOT.\"), mdx(\"p\", null, \"The architecture was not bad but I didnt was satisfied by those numbers, the system was not scalable enough for me, so I started study other approches for the same problem.\"), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#optimal-number-of-lines\"\n  }), \"The optimal number of lines of code is zero\")), mdx(\"p\", null, \"Maybe you already have heard this phrase somewhere, this phrase stuck in my head during my studies and then I started to think in strange solutions.\"), mdx(\"p\", null, \"One of those solutions was: What if I cache the GET: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/polls\"), \" in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS S3\"), \"? Then the frontend just need to get the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"JSON\"), \" from the bucket, and everytime I update the\\ndatabase I just update the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"JSON\"), \" in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"S3\"), \", with this approach, I could reduce the amount of requests to get the polls to zero, instant, and this can handle \\\"infinite\\\" amount of\\nrequests.\"), mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/mind-blown-shocked.gif\",\n    alt: \"Explosion mind\"\n  }), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"My first reaction for this approach was exactly this gif.\")), mdx(\"p\", null, \"But using \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS S3\"), \" sounds too ugly, we are Engineers, should have a \\\"better\\\" option.\"), mdx(\"p\", null, \"So I remember \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS Cloudfront\"), \", if we can cache files, we can cache API requests because the return of a request is just a text file with the format the system knows, the JSON.\\nWe could use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"max-age\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Cache-Control\"), \" headers to keep the data in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS Cloudfront\"), \" for some seconds until the need to make the request to my API.\\nWith this setup, only one request every 3s, ideally, will reach my API instead every request hitting the API in the old way.\"), mdx(\"p\", null, \"I said ideally because the cloudfare will cache in the edge, if two person in different parts of the globe make a request, we still need to make two requests because the servers\\nwill be different, and this is called \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.youtube.com/watch?v=RY_2gElt3SA\"\n  }), \"eventual consistency\"), \" and for what I was building, this is not a problem.\"), mdx(\"p\", null, \"Okay, sounds good, but what about the votes, another hot path of my code, what I can do with that guy? Then I started to think again in that phrase\\nand I found a solution with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS SQS\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS API Gateway HTTP\"), \".\"), mdx(\"p\", null, \"Did you know you can \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-aws-services.html\"\n  }), \"expose a \", mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"SQS\"), \" queue directly with \", mdx(\"inlineCode\", {\n    parentName: \"a\"\n  }, \"Api Gateway\")), \"?\\nI didn't know too, with this guy, essencialy anyone can create an item inside the queue.\\nFor me, this was perfect because was exactly what I was doing but I had my API to handle it directly, so if I use this integration, I can cut to zero the number of requests\\nhitting my API to vote (not for processing the votes), perfect!\"), mdx(\"p\", null, \"And with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SQS\"), \", we can configure \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Batch Window\"), \", that you can configure to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS\"), \" group the items in the queue until they reach X amount in Y seconds before call something to process it.\\nIn my case, I configure to process \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"300\"), \" items in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"3s\"), \", because I have ALOT of votes, we get more than this in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"1s\"), \" so \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"3s\"), \" is very safe. Also, I could not configure more than \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"300\"), \" because\\nthe lambda didn't support those amount of data, so \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"300\"), \" was my limit.\"), mdx(\"p\", null, \"Another advantage of this solution with queue, I can do batch insert in the database, which is orders of magnitude faster than doing one insert for each item.\\nIn the final, instead writing one insert for every vote, I do only one insert every \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"300\"), \" votes.\"), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#v2-architecture\"\n  }), \"v2 Architecture\")), mdx(\"p\", null, \"Okay, let's summarize your new architecture:\"), mdx(\"p\", null, \"For \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/polls\"), \": We will use \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS Cloudfront\"), \" in front of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS API Gateway\"), \" and the API will return \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Cache-Control: s-max-age=3s\"), \" to cache the data for 3s until \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Cloudfront\"), \" need to hit the API again.\"), mdx(\"p\", null, \"For \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/polls/{pollId}/signers/{signerId}\"), \": We will change this route to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/polls/signers/sqs\"), \" and configure inside \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"API Gateway\"), \" to forward directly to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SQS\"), \" queue.\\nThen, we configure this queue to call your Lambda using \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://serverless-adapter.viniciusl.com.br\"\n  }), \"Serverless Adapter\"), \" and \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://serverless-adapter.viniciusl.com.br/docs/main/adapters/aws/sqs\"\n  }), \"SQS Adapter\"), \"\\nthat will transform the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SQS\"), \" event in a HTTP Post request to enable us to keep the logic in the same codebase.\\nInside the code, we can use the same strategy of doing validations with \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ElastiCache\"), \" and in the final, we just do a batch insert in the database.\"), mdx(\"p\", null, \"Now, the architecture looks like:\"), mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/v2_architecture.jpg\",\n    alt: \"The v2 architecture.\"\n  }), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#v2-metrics\"\n  }), \"The metrics of V2\")), mdx(\"p\", null, \"Well, the most exciting part of doing some optimization, is to see the metrics if it actually helped.\"), mdx(\"p\", null, \"Let's see the metrics for 700k votes did in stress tests:\"), mdx(\"a\", {\n    href: \"/images/posts/2022/12/08/lambda_v2.png\",\n    target: \"_blank\"\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/lambda_v2.jpg\",\n    alt: \"The amount of invocations in v2.\"\n  })), mdx(\"p\", null, \"And for the database, we have these metrics.\"), mdx(\"a\", {\n    href: \"/images/posts/2022/12/08/cpu_v2.png\",\n    target: \"_blank\"\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/cpu_v2.png\",\n    alt: \"The database CPU usage.\"\n  })), mdx(\"a\", {\n    href: \"/images/posts/2022/12/08/commits_v2.png\",\n    target: \"_blank\"\n  }, mdx(\"img\", {\n    style: {\n      width: '100%'\n    },\n    src: \"/images/posts/2022/12/08/commits_v2.png\",\n    alt: \"The database commits.\"\n  })), mdx(\"blockquote\", null, mdx(\"p\", {\n    parentName: \"blockquote\"\n  }, \"Hint: Click in the image to open in higher resolution.\")), mdx(\"p\", null, \"To summarize:\"), mdx(\"table\", null, mdx(\"thead\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"thead\"\n  }, mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Version\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Num. of Votes\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Invocations (peak)\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Concurrency (peak)\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"Number of vCPU\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"CPU Usage (peak)\"), mdx(\"th\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"RDS Commits (peak)\"))), mdx(\"tbody\", {\n    parentName: \"table\"\n  }, mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"v1\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"280k\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"1,51 million\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"200\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"1,5\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"40%\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"400 commit/s\")), mdx(\"tr\", {\n    parentName: \"tbody\"\n  }, mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"v2\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"700k\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"1,6 thousand\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"11\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"0,5\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"15%\"), mdx(\"td\", _extends({\n    parentName: \"tr\"\n  }, {\n    \"align\": \"center\"\n  }), \"15 commit/s\")))), mdx(\"h2\", null, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#conclusion\"\n  }), \"Conclusion\")), mdx(\"p\", null, \"I hope with this article you could learn something about \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS Cloudfront\"), \", \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS SQS\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AWS API Gateway\"), \", but just not about technologies but also about the mindset.\\nThe mindset of also seeking for improvements to reduce costs, to improve the scalability and availability of the system you are working on, and the most important, the thinking of\\nnever being satisfated with something just because it works, everything could be improved, you just didn't learn how yet.\"), mdx(\"p\", null, \"Also, as a developer, always read the docs of the services of the cloud of your company, to be able to identify and improvements like these.\\nI'm not saying you to take the certificate of the cloud, but sometimes just read the documentation and see what they can do, do little experiments to see what you can do with it.\"), mdx(\"p\", null, \"Finally, a tip about using these services, monitor the usage and put limits in your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"API Gateway\"), \", scalable solutions are great until the bill cames out (:\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"First, the results A journey about how I went from this amount of invocations in a voting system: To this number of invocations, doing 2x…","timeToRead":6,"wordCount":{"words":1691},"frontmatter":{"title":"From a million to a thousand requests with correct caching","tags":["AWS","SQS","Cloudfront","Lambda","NestJS","Fastify"],"date":"2022-12-10T00:00:00.000Z","dateModified":"2022-12-10T00:00:00.000Z","author":"Vinícius Lourenço","status":null,"isPrivate":null,"url":null,"misc":null,"featuredImage":{"childImageSharp":{"original":{"width":1380,"height":828,"src":"/static/08-from-million-to-thousand-requests-with-correct-caching-991f774cfb5d5881ee59f32723dfbf25.jpg"},"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQD/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAbc6sy6wx//EABsQAQACAgMAAAAAAAAAAAAAAAIBAwAEERIT/9oACAEBAAEFArrZKGxxldkMuodvExgEVn//xAAXEQEBAQEAAAAAAAAAAAAAAAABAAJB/9oACAEDAQE/ATR0m//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAMAAgMAAAAAAAAAAAAAAAABEQIxEEGB/9oACAEBAAY/AmukbvpUWb4mJ//EABwQAQADAAIDAAAAAAAAAAAAAAEAESExQVGBof/aAAgBAQABPyG+wOYNLkF21PTHowk8xcr2FLPhK5Zzvc//2gAMAwEAAgADAAAAEKTf/8QAFxEBAQEBAAAAAAAAAAAAAAAAEQEAMf/aAAgBAwEBPxCWCYNOb//EABcRAQEBAQAAAAAAAAAAAAAAAAEAMWH/2gAIAQIBAT8QRcY7f//EAB0QAQEAAgIDAQAAAAAAAAAAAAERADEhQWFxofD/2gAIAQEAAT8QWFxIE1s6xeongerzvKqkaOnc+mVGUCOBmt5KHE/GsLuLpVU9rn//2Q==","aspectRatio":1.6666666666666667,"src":"/static/991f774cfb5d5881ee59f32723dfbf25/a6c62/08-from-million-to-thousand-requests-with-correct-caching.jpg","srcSet":"/static/991f774cfb5d5881ee59f32723dfbf25/b3cab/08-from-million-to-thousand-requests-with-correct-caching.jpg 300w,\n/static/991f774cfb5d5881ee59f32723dfbf25/39f27/08-from-million-to-thousand-requests-with-correct-caching.jpg 600w,\n/static/991f774cfb5d5881ee59f32723dfbf25/a6c62/08-from-million-to-thousand-requests-with-correct-caching.jpg 1200w,\n/static/991f774cfb5d5881ee59f32723dfbf25/a6c4b/08-from-million-to-thousand-requests-with-correct-caching.jpg 1380w","sizes":"(max-width: 1200px) 100vw, 1200px"},"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAQD/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAbc6sy6wx//EABsQAQACAgMAAAAAAAAAAAAAAAIBAwAEERIT/9oACAEBAAEFArrZKGxxldkMuodvExgEVn//xAAXEQEBAQEAAAAAAAAAAAAAAAABAAJB/9oACAEDAQE/ATR0m//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABsQAAMAAgMAAAAAAAAAAAAAAAABEQIxEEGB/9oACAEBAAY/AmukbvpUWb4mJ//EABwQAQADAAIDAAAAAAAAAAAAAAEAESExQVGBof/aAAgBAQABPyG+wOYNLkF21PTHowk8xcr2FLPhK5Zzvc//2gAMAwEAAgADAAAAEKTf/8QAFxEBAQEBAAAAAAAAAAAAAAAAEQEAMf/aAAgBAwEBPxCWCYNOb//EABcRAQEBAQAAAAAAAAAAAAAAAAEAMWH/2gAIAQIBAT8QRcY7f//EAB0QAQEAAgIDAQAAAAAAAAAAAAERADEhQWFxofD/2gAIAQEAAT8QWFxIE1s6xeongerzvKqkaOnc+mVGUCOBmt5KHE/GsLuLpVU9rn//2Q==","width":400,"height":240,"src":"/static/991f774cfb5d5881ee59f32723dfbf25/64b17/08-from-million-to-thousand-requests-with-correct-caching.jpg","srcSet":"/static/991f774cfb5d5881ee59f32723dfbf25/64b17/08-from-million-to-thousand-requests-with-correct-caching.jpg 1x,\n/static/991f774cfb5d5881ee59f32723dfbf25/39f27/08-from-million-to-thousand-requests-with-correct-caching.jpg 1.5x,\n/static/991f774cfb5d5881ee59f32723dfbf25/a1eb1/08-from-million-to-thousand-requests-with-correct-caching.jpg 2x"},"id":"af725526-3540-545a-84c4-b83ed0029ff8"}},"embeddedImages":null},"fields":{"slug":"/posts/2022/12/08-from-million-to-thousand-requests-with-correct-caching/","owner":"source","parent":"posts"}}},"pageContext":{"id":"9c69f02d-290b-5317-8fa0-a052a99c39bc","prev":null,"next":{"frontmatter":{"title":"UQR","status":null},"fields":{"slug":"/projects/2020-11-01-uqr/"}},"parent":"posts"}},"staticQueryHashes":["1469902088","1756707795","1826328981"]}