<!DOCTYPE html><html lang="pt"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.25.9"/><meta data-react-helmet="true" name="description" content="First, the results A journey on how I went from that amount of invocations in a voting system: For that number of invocations, making 2x as…"/><meta data-react-helmet="true" name="image" content="https://viniciusl.com.br/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg"/><meta data-react-helmet="true" name="image:alt" content="First, the results A journey on how I went from that amount of invocations in a voting system: For that number of invocations, making 2x as…"/><meta data-react-helmet="true" name="gatsby-theme" content="@pauliescanlon/gatsby-theme-terminal"/><meta data-react-helmet="true" name="keywords" content="AWS, SQS, Cloudfront, Lambda, NestJS, Fastify"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Vinícius Lourenço | From a million invocations to thousand with correct caching"/><meta data-react-helmet="true" property="og:url" content="https://viniciusl.com.br/posts/2022/12/08-from-million-invocations-to-thousand-with-correct-caching/"/><meta data-react-helmet="true" property="og:description" content="First, the results A journey on how I went from that amount of invocations in a voting system: For that number of invocations, making 2x as…"/><meta data-react-helmet="true" property="og:image" content="https://viniciusl.com.br/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg"/><meta data-react-helmet="true" property="og:image:alt" content="First, the results A journey on how I went from that amount of invocations in a voting system: For that number of invocations, making 2x as…"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Vinícius Lourenço | From a million invocations to thousand with correct caching"/><meta data-react-helmet="true" name="twitter:url" content="https://viniciusl.com.br/posts/2022/12/08-from-million-invocations-to-thousand-with-correct-caching/"/><meta data-react-helmet="true" name="twitter:description" content="First, the results A journey on how I went from that amount of invocations in a voting system: For that number of invocations, making 2x as…"/><meta data-react-helmet="true" name="twitter:image" content="https://viniciusl.com.br/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg"/><meta data-react-helmet="true" name="twitter:image:alt" content="First, the results A journey on how I went from that amount of invocations in a voting system: For that number of invocations, making 2x as…"/><title data-react-helmet="true">Vinícius Lourenço | From a million invocations to thousand with correct caching</title><link data-react-helmet="true" rel="canonical" href="https://viniciusl.com.br/posts/2022/12/08-from-million-invocations-to-thousand-with-correct-caching/"/><link data-react-helmet="true" rel="icon" type="image/png" sizes="16x16" href="https://viniciusl.com.br/images/favicon-16x16.png"/><link data-react-helmet="true" rel="icon" type="image/png" sizes="32x32" href="https://viniciusl.com.br/images/favicon-32x32.png"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="sitemap" type="application/xml" href="/sitemap/sitemap-index.xml"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.documentElement.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion="css-global 10it7en">html{--theme-ui-colors-text:#ffffff;--theme-ui-colors-background:#282a36;--theme-ui-colors-muted:#8394ca;--theme-ui-colors-highlight:#5a6084;--theme-ui-colors-surface:#323442;--theme-ui-colors-primary:#ff79c6;--theme-ui-colors-secondary:#8be9fd;--theme-ui-colors-success:#50fa7b;--theme-ui-colors-error:#ff5555;--theme-ui-colors-black:#000000;color:var(--theme-ui-colors-text);background-color:var(--theme-ui-colors-background);}</style><style data-emotion="css-global s0cgw1">*{box-sizing:border-box;}html{font-family:Inconsolata,monospace;font-weight:400;font-size:16px;line-height:1.75;}html input:-webkit-autofill:first-line{color:var(--theme-ui-colors-primary)!important;}html a{-webkit-transition:.2s linear box-shadow;transition:.2s linear box-shadow;}html a:focus{outline:none;box-shadow:0 2px 0 0 var(--theme-ui-colors-primary);}html pre{color:#d6deeb;background-color:#011627;font-family:monospace;border-radius:0;overflow:auto;font-size:13px;padding:16px;margin-top:48px!important;margin-bottom:48px!important;}html pre .changed{color:rgb(162, 191, 252);font-style:italic;}html pre .deleted{color:rgba(239, 83, 80, 0.56);font-style:italic;}html pre .inserted,html pre .attr-name{color:rgb(173, 219, 103);font-style:italic;}html pre .comment{color:rgb(99, 119, 119);font-style:italic;}html pre .string,html pre .url{color:rgb(173, 219, 103);}html pre .variable{color:rgb(214, 222, 235);}html pre .number{color:rgb(247, 140, 108);}html pre .builtin,html pre .char,html pre .constant,html pre .function{color:rgb(130, 170, 255);}html pre .punctuation{color:rgb(199, 146, 234);}html pre .selector,html pre .doctype{color:rgb(199, 146, 234);font-style:italic;}html pre .class-name{color:rgb(255, 203, 139);}html pre .tag,html pre .operator,html pre .keyword{color:rgb(127, 219, 202);}html pre .boolean{color:rgb(255, 88, 116);}html pre .property{color:rgb(128, 203, 196);}html pre .namespace{color:rgb(178, 204, 214);}html pre .highlight{background:hsla(0, 0%, 30%, .5);}body{margin:0;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion="css-global nisjmm">@font-face{font-family:'Inconsolata';src:url('https://viniciusl.com.br/fonts/Inconsolata-Regular.woff2') format('woff2');font-weight:400;font-style:normal;}@font-face{font-family:'Inconsolata';src:url('https://viniciusl.com.br/fonts/Inconsolata-Bold.woff2') format('woff2');font-weight:700;font-style:normal;}</style><style data-emotion="css 1ja0sfa">.css-1ja0sfa{box-sizing:border-box;margin:0;min-width:0;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;background-color:var(--theme-ui-colors-background);border-bottom:1px solid var(--theme-ui-colors-surface);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;height:48px;margin-left:0;overflow:hidden;position:fixed;padding-left:16px;padding-right:16px;width:100%;z-index:997;}@media screen and (min-width: 40em){.css-1ja0sfa{margin-left:0;padding-left:32px;padding-right:32px;width:100%;}}@media screen and (min-width: 52em){.css-1ja0sfa{margin-left:0;width:100%;}}@media screen and (min-width: 64em){.css-1ja0sfa{margin-left:280px;width:calc(100% - 280px);}}</style><header class="css-1ja0sfa"><style data-emotion="css 144mmht">.css-144mmht{box-sizing:border-box;margin:0;min-width:0;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}@media screen and (min-width: 40em){.css-144mmht{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media screen and (min-width: 52em){.css-144mmht{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media screen and (min-width: 64em){.css-144mmht{display:none;}}</style><div class="css-144mmht"><a href="/" style="text-decoration:none;color:white;font-size:1.4rem">H4ad</a></div><style data-emotion="css v4uozr">.css-v4uozr{box-sizing:border-box;margin:0;min-width:0;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-basis:100%;-ms-flex-preferred-size:100%;flex-basis:100%;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}@media screen and (min-width: 40em){.css-v4uozr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media screen and (min-width: 52em){.css-v4uozr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media screen and (min-width: 64em){.css-v4uozr{display:none;}}</style><div class="css-v4uozr"><style data-emotion="css 1ak3clr-IconButton">.css-1ak3clr-IconButton{box-sizing:border-box;margin:0;min-width:0;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding:4px;width:32px;height:32px;color:inherit;background-color:transparent;border:none;border-radius:4px;cursor:pointer;border-radius:0;}.css-1ak3clr-IconButton:focus{outline:none;-webkit-transition:.2s linear box-shadow;transition:.2s linear box-shadow;box-shadow:0 0 0 2px var(--theme-ui-colors-muted);}</style><button title="Menu" aria-label="Toggle Menu" class="css-1ak3clr-IconButton"><style data-emotion="css ipc245">.css-ipc245{box-sizing:border-box;margin:0;min-width:0;display:block;margin:0;}</style><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentcolor" viewBox="0 0 24 24" class="css-ipc245"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button></div></header><style data-emotion="css tqqet">.css-tqqet{box-sizing:border-box;margin:0;min-width:0;width:100%;margin-left:auto;margin-right:auto;margin:0 auto;max-width:1200px;}</style><div class="css-tqqet"><style data-emotion="css 1p8vgs9">.css-1p8vgs9{box-sizing:border-box;margin:0;min-width:0;background-color:var(--theme-ui-colors-background);height:100%;left:-280px;position:fixed;-webkit-transition:.3s ease-in-out left;transition:.3s ease-in-out left;width:280px;z-index:999;}@media screen and (min-width: 40em){.css-1p8vgs9{left:-280px;}}@media screen and (min-width: 52em){.css-1p8vgs9{left:-280px;}}@media screen and (min-width: 64em){.css-1p8vgs9{left:0px;}}</style><div class="css-1p8vgs9"><style data-emotion="css x6h0no">.css-x6h0no{box-sizing:border-box;margin:0;min-width:0;border-right:1px solid var(--theme-ui-colors-surface);height:100%;left:-280px;-webkit-transition:.3s ease-in-out left;transition:.3s ease-in-out left;position:relative;}@media screen and (min-width: 40em){.css-x6h0no{left:-280px;}}@media screen and (min-width: 52em){.css-x6h0no{left:-280px;}}@media screen and (min-width: 64em){.css-x6h0no{left:0;}}</style><div class="css-x6h0no"><style data-emotion="css 1xtefx3">.css-1xtefx3{box-sizing:border-box;margin:0;min-width:0;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;height:48px;-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;over-flow:hidden;padding-left:32px;padding-right:32px;}@media screen and (min-width: 40em){.css-1xtefx3{-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;}}@media screen and (min-width: 52em){.css-1xtefx3{-webkit-box-pack:start;-ms-flex-pack:start;-webkit-justify-content:flex-start;justify-content:flex-start;}}@media screen and (min-width: 64em){.css-1xtefx3{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;}}</style><div class="css-1xtefx3"><a href="/" style="text-decoration:none;color:white;font-size:1.4rem">H4ad</a></div><style data-emotion="css 9vkrg4">.css-9vkrg4{box-sizing:border-box;margin:0;min-width:0;height:100%;padding-top:16px;padding-bottom:16px;padding-left:32px;padding-right:32px;}</style><nav class="css-9vkrg4"><style data-emotion="css dyybnr">.css-dyybnr{box-sizing:border-box;margin:0;min-width:0;list-style:none;margin-top:8px;padding:0;}</style><ul class="css-dyybnr"><style data-emotion="css 12yllt8">.css-12yllt8{box-sizing:border-box;margin:0;min-width:0;text-align:left;}@media screen and (min-width: 40em){.css-12yllt8{text-align:left;}}@media screen and (min-width: 52em){.css-12yllt8{text-align:left;}}@media screen and (min-width: 64em){.css-12yllt8{text-align:right;}}</style><li class="css-12yllt8"><style data-emotion="css 12evs35">.css-12evs35{box-sizing:border-box;margin:0;min-width:0;color:inherit;-webkit-text-decoration:none;text-decoration:none;font-weight:700;display:inline-block;color:var(--theme-ui-colors-muted);-webkit-transition:.2s linear box-shadow;transition:.2s linear box-shadow;font-weight:400;}.css-12evs35:hover,.css-12evs35:focus,.css-12evs35.active{color:var(--theme-ui-colors-primary);}.css-12evs35:focus{outline:none;box-shadow:0 2px 0 0 var(--theme-ui-colors-primary);}.css-12evs35:before{padding-right:8px;content:"-";}@media screen and (min-width: 40em){.css-12evs35:before{padding-right:8px;content:"-";}}@media screen and (min-width: 52em){.css-12evs35:before{padding-right:8px;content:"-";}}@media screen and (min-width: 64em){.css-12evs35:before{padding-right:0;content:"";}}.css-12evs35:after{padding-left:0;content:"";}@media screen and (min-width: 40em){.css-12evs35:after{padding-left:0;content:"";}}@media screen and (min-width: 52em){.css-12evs35:after{padding-left:0;content:"";}}@media screen and (min-width: 64em){.css-12evs35:after{padding-left:8px;content:"-";}}.css-12evs35:hover{color:var(--theme-ui-colors-text);-webkit-transition:.2s linear color;transition:.2s linear color;}.css-12evs35[aria-current="page"]{color:var(--theme-ui-colors-text);pointer-events:none;}</style><a class="css-12evs35" href="/">About me</a></li><li class="css-12yllt8"><a class="css-12evs35" href="/posts/">Posts</a></li><li class="css-12yllt8"><a class="css-12evs35" href="/projects/">My Projects</a></li></ul></nav></div></div><style data-emotion="css nvcgve">.css-nvcgve{box-sizing:border-box;margin:0;min-width:0;background-color:rgba(0,0,0,0.8);display:none;height:100%;-webkit-box-pack:end;-ms-flex-pack:end;-webkit-justify-content:flex-end;justify-content:flex-end;padding-left:16px;padding-right:16px;padding-top:8px;padding-bottom:8px;position:fixed;-webkit-transition:.2s linear background-color;transition:.2s linear background-color;width:100%;z-index:998;}@media screen and (min-width: 40em){.css-nvcgve{display:none;padding-left:32px;padding-right:32px;}}@media screen and (min-width: 52em){.css-nvcgve{display:none;}}@media screen and (min-width: 64em){.css-nvcgve{display:none;}}.css-nvcgve:focus{outline:none;background-color:rgba(0,0,0,0.6);}</style><div role="button" tabindex="0" class="css-nvcgve"><style data-emotion="css 1ak3clr-IconButton">.css-1ak3clr-IconButton{box-sizing:border-box;margin:0;min-width:0;-webkit-appearance:none;-moz-appearance:none;-ms-appearance:none;appearance:none;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;padding:4px;width:32px;height:32px;color:inherit;background-color:transparent;border:none;border-radius:4px;cursor:pointer;border-radius:0;}.css-1ak3clr-IconButton:focus{outline:none;-webkit-transition:.2s linear box-shadow;transition:.2s linear box-shadow;box-shadow:0 0 0 2px var(--theme-ui-colors-muted);}</style><button title="Close" aria-label="Close" class="css-1ak3clr-IconButton"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></div><style data-emotion="css 1ov7hmb">.css-1ov7hmb{box-sizing:border-box;margin:0;min-width:0;display:block;margin-left:0;padding-left:16px;padding-right:16px;padding-top:64px;padding-bottom:64px;-webkit-transition:.3s ease-in-out margin-left;transition:.3s ease-in-out margin-left;}@media screen and (min-width: 40em){.css-1ov7hmb{margin-left:0;padding-left:32px;padding-right:32px;}}@media screen and (min-width: 52em){.css-1ov7hmb{margin-left:0;}}@media screen and (min-width: 64em){.css-1ov7hmb{margin-left:280px;}}</style><main class="css-1ov7hmb"><style data-emotion="css ktxhrn">.css-ktxhrn{box-sizing:border-box;margin:0;min-width:0;margin-bottom:32px;}</style><div class="css-ktxhrn"><div data-gatsby-image-wrapper="" class="gatsby-image-wrapper"><div aria-hidden="true" style="padding-top:60%"></div><img aria-hidden="true" data-placeholder-image="" style="opacity:1;transition:opacity 500ms linear" decoding="async" src="data:image/jpeg;base64,/9j/2wBDAAoHBwgHBgoICAgLCgoLDhgQDg0NDh0VFhEYIx8lJCIfIiEmKzcvJik0KSEiMEExNDk7Pj4+JS5ESUM8SDc9Pjv/2wBDAQoLCw4NDhwQEBw7KCIoOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozv/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUD/8QAFgEBAQEAAAAAAAAAAAAAAAAAAwEC/9oADAMBAAIQAxAAAAGpjRxy1AUv/8QAGRAAAwEBAQAAAAAAAAAAAAAAAgMEAQAS/9oACAEBAAEFAqqjBi7sDUvFwNmV7yVecpQID//EABkRAAMAAwAAAAAAAAAAAAAAAAABAhEhMf/aAAgBAwEBPwGblLDQ+6P/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPwFGf//EABwQAAICAwEBAAAAAAAAAAAAAAABAhIRITFBUf/aAAgBAQAGPwKSyqxa16zLllfGyyL12+nCkFo//8QAHBABAQEAAQUAAAAAAAAAAAAAAREAITFBUWHR/9oACAEBAAE/IUSXDFAl1wWMa5kYnh1CD3XNmjh0ej5uJaq1qu//2gAMAwEAAgADAAAAEKAv/8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARMf/aAAgBAwEBPxB5rmKeL//EABcRAQEBAQAAAAAAAAAAAAAAAAEAITH/2gAIAQIBAT8QQ4xzb//EABwQAQEAAwADAQAAAAAAAAAAAAERACExQVFhkf/aAAgBAQABPxAjnC9HZChb65i0KpokNyl798zHtmv9Az8TLIQIIfBaPK5w44u+7wZWCZkuqvXP/9k=" alt=""/><picture><source type="image/avif" data-srcset="/static/991f774cfb5d5881ee59f32723dfbf25/779f9/08-from-million-invocations-to-thousand-with-correct-caching.avif 750w,/static/991f774cfb5d5881ee59f32723dfbf25/84b1e/08-from-million-invocations-to-thousand-with-correct-caching.avif 1080w,/static/991f774cfb5d5881ee59f32723dfbf25/2fae5/08-from-million-invocations-to-thousand-with-correct-caching.avif 1366w,/static/991f774cfb5d5881ee59f32723dfbf25/f5c0b/08-from-million-invocations-to-thousand-with-correct-caching.avif 1380w" sizes="100vw"/><source type="image/webp" data-srcset="/static/991f774cfb5d5881ee59f32723dfbf25/e49d5/08-from-million-invocations-to-thousand-with-correct-caching.webp 750w,/static/991f774cfb5d5881ee59f32723dfbf25/e0103/08-from-million-invocations-to-thousand-with-correct-caching.webp 1080w,/static/991f774cfb5d5881ee59f32723dfbf25/bb048/08-from-million-invocations-to-thousand-with-correct-caching.webp 1366w,/static/991f774cfb5d5881ee59f32723dfbf25/40c0d/08-from-million-invocations-to-thousand-with-correct-caching.webp 1380w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" data-src="/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg" data-srcset="/static/991f774cfb5d5881ee59f32723dfbf25/54faf/08-from-million-invocations-to-thousand-with-correct-caching.jpg 750w,/static/991f774cfb5d5881ee59f32723dfbf25/6bcf6/08-from-million-invocations-to-thousand-with-correct-caching.jpg 1080w,/static/991f774cfb5d5881ee59f32723dfbf25/e0599/08-from-million-invocations-to-thousand-with-correct-caching.jpg 1366w,/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg 1380w" alt="From a million invocations to thousand with correct caching-image"/></picture><noscript><picture><source type="image/avif" srcSet="/static/991f774cfb5d5881ee59f32723dfbf25/779f9/08-from-million-invocations-to-thousand-with-correct-caching.avif 750w,/static/991f774cfb5d5881ee59f32723dfbf25/84b1e/08-from-million-invocations-to-thousand-with-correct-caching.avif 1080w,/static/991f774cfb5d5881ee59f32723dfbf25/2fae5/08-from-million-invocations-to-thousand-with-correct-caching.avif 1366w,/static/991f774cfb5d5881ee59f32723dfbf25/f5c0b/08-from-million-invocations-to-thousand-with-correct-caching.avif 1380w" sizes="100vw"/><source type="image/webp" srcSet="/static/991f774cfb5d5881ee59f32723dfbf25/e49d5/08-from-million-invocations-to-thousand-with-correct-caching.webp 750w,/static/991f774cfb5d5881ee59f32723dfbf25/e0103/08-from-million-invocations-to-thousand-with-correct-caching.webp 1080w,/static/991f774cfb5d5881ee59f32723dfbf25/bb048/08-from-million-invocations-to-thousand-with-correct-caching.webp 1366w,/static/991f774cfb5d5881ee59f32723dfbf25/40c0d/08-from-million-invocations-to-thousand-with-correct-caching.webp 1380w" sizes="100vw"/><img data-gatsby-image-ssr="" data-main-image="" style="opacity:0" sizes="100vw" decoding="async" loading="lazy" src="/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg" srcSet="/static/991f774cfb5d5881ee59f32723dfbf25/54faf/08-from-million-invocations-to-thousand-with-correct-caching.jpg 750w,/static/991f774cfb5d5881ee59f32723dfbf25/6bcf6/08-from-million-invocations-to-thousand-with-correct-caching.jpg 1080w,/static/991f774cfb5d5881ee59f32723dfbf25/e0599/08-from-million-invocations-to-thousand-with-correct-caching.jpg 1366w,/static/991f774cfb5d5881ee59f32723dfbf25/67751/08-from-million-invocations-to-thousand-with-correct-caching.jpg 1380w" alt="From a million invocations to thousand with correct caching-image"/></picture></noscript><script type="module">const t="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;if(t){const t=document.querySelectorAll("img[data-main-image]");for(let e of t){e.dataset.src&&(e.setAttribute("src",e.dataset.src),e.removeAttribute("data-src")),e.dataset.srcset&&(e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset"));const t=e.parentNode.querySelectorAll("source[data-srcset]");for(let e of t)e.setAttribute("srcset",e.dataset.srcset),e.removeAttribute("data-srcset");e.complete&&(e.style.opacity=1,e.parentNode.parentNode.querySelector("[data-placeholder-image]").style.opacity=0)}}</script></div></div><style data-emotion="css 70xqx6">.css-70xqx6{box-sizing:border-box;margin:0;min-width:0;font-family:Inconsolata,monospace;font-weight:700;line-height:1.125;font-family:Inconsolata,monospace;font-weight:700;font-size:28px;margin-top:0;margin-bottom:16px;color:var(--theme-ui-colors-primary);margin-bottom:32px;}.css-70xqx6 a{color:inherit;}.css-70xqx6::before{content:'→';color:var(--theme-ui-colors-success);margin-right:8px;}.css-70xqx6::after{content:'()';color:var(--theme-ui-colors-secondary);margin-left:4px;}</style><h1 class="css-70xqx6">From a million invocations to thousand with correct caching</h1><style data-emotion="css 12cdd7t">.css-12cdd7t{box-sizing:border-box;margin:0;min-width:0;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-bottom:4px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="css-12cdd7t"><style data-emotion="css 14l2yhb">.css-14l2yhb{box-sizing:border-box;margin:0;min-width:0;width:100%;}@media screen and (min-width: 40em){.css-14l2yhb{width:50%;}}</style><div class="css-14l2yhb"><style data-emotion="css omavvl">.css-omavvl{box-sizing:border-box;margin:0;min-width:0;color:var(--theme-ui-colors-muted);}</style><div class="css-omavvl">Published At: <!-- -->10-Dec-2022</div></div><div class="css-14l2yhb"><style data-emotion="css 11eyban">.css-11eyban{box-sizing:border-box;margin:0;min-width:0;color:var(--theme-ui-colors-muted);text-align:left;}@media screen and (min-width: 40em){.css-11eyban{text-align:right;}}</style><div class="css-11eyban">Modified At: <!-- -->10-Dec-2022</div></div></div><style data-emotion="css 1kf3d22">.css-1kf3d22{box-sizing:border-box;margin:0;min-width:0;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-bottom:16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="css-1kf3d22"><div class="css-14l2yhb"><div class="css-omavvl">7 min read / 1894 words</div></div><div class="css-14l2yhb"><div class="css-11eyban">Author: <!-- -->Vinícius Lourenço</div></div></div><style data-emotion="css uq1pv2">.css-uq1pv2{box-sizing:border-box;margin:0;min-width:0;margin-bottom:16px;}</style><div class="css-uq1pv2"><style data-emotion="css 1erkzv5">.css-1erkzv5{box-sizing:border-box;margin:0;min-width:0;display:inline-block;vertical-align:baseline;font-size:12px;font-weight:700;white-space:nowrap;padding-left:4px;padding-right:4px;border-radius:2px;color:white;background-color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);border-color:var(--theme-ui-colors-primary);font-size:12px;border-radius:0;border-width:1px;border-style:solid;background-color:transparent;padding-left:8px;padding-right:8px;padding-top:4px;padding-bottom:4px;margin-bottom:8px;margin-right:8px;color:#ff79c6;border-color:#ff79c6;}</style><div class="css-1erkzv5">AWS</div><style data-emotion="css lo2x81">.css-lo2x81{box-sizing:border-box;margin:0;min-width:0;display:inline-block;vertical-align:baseline;font-size:12px;font-weight:700;white-space:nowrap;padding-left:4px;padding-right:4px;border-radius:2px;color:white;background-color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);border-color:var(--theme-ui-colors-primary);font-size:12px;border-radius:0;border-width:1px;border-style:solid;background-color:transparent;padding-left:8px;padding-right:8px;padding-top:4px;padding-bottom:4px;margin-bottom:8px;margin-right:8px;color:#ea7dc6;border-color:#ea7dc6;}</style><div class="css-lo2x81">SQS</div><style data-emotion="css bgpzkk">.css-bgpzkk{box-sizing:border-box;margin:0;min-width:0;display:inline-block;vertical-align:baseline;font-size:12px;font-weight:700;white-space:nowrap;padding-left:4px;padding-right:4px;border-radius:2px;color:white;background-color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);border-color:var(--theme-ui-colors-primary);font-size:12px;border-radius:0;border-width:1px;border-style:solid;background-color:transparent;padding-left:8px;padding-right:8px;padding-top:4px;padding-bottom:4px;margin-bottom:8px;margin-right:8px;color:#d582c7;border-color:#d582c7;}</style><div class="css-bgpzkk">Cloudfront</div><style data-emotion="css 12vtw9o">.css-12vtw9o{box-sizing:border-box;margin:0;min-width:0;display:inline-block;vertical-align:baseline;font-size:12px;font-weight:700;white-space:nowrap;padding-left:4px;padding-right:4px;border-radius:2px;color:white;background-color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);border-color:var(--theme-ui-colors-primary);font-size:12px;border-radius:0;border-width:1px;border-style:solid;background-color:transparent;padding-left:8px;padding-right:8px;padding-top:4px;padding-bottom:4px;margin-bottom:8px;margin-right:8px;color:#c186c8;border-color:#c186c8;}</style><div class="css-12vtw9o">Lambda</div><style data-emotion="css go3r0h">.css-go3r0h{box-sizing:border-box;margin:0;min-width:0;display:inline-block;vertical-align:baseline;font-size:12px;font-weight:700;white-space:nowrap;padding-left:4px;padding-right:4px;border-radius:2px;color:white;background-color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);border-color:var(--theme-ui-colors-primary);font-size:12px;border-radius:0;border-width:1px;border-style:solid;background-color:transparent;padding-left:8px;padding-right:8px;padding-top:4px;padding-bottom:4px;margin-bottom:8px;margin-right:8px;color:#ac8bc8;border-color:#ac8bc8;}</style><div class="css-go3r0h">NestJS</div><style data-emotion="css htrsmt">.css-htrsmt{box-sizing:border-box;margin:0;min-width:0;display:inline-block;vertical-align:baseline;font-size:12px;font-weight:700;white-space:nowrap;padding-left:4px;padding-right:4px;border-radius:2px;color:white;background-color:var(--theme-ui-colors-primary);color:var(--theme-ui-colors-primary);border-color:var(--theme-ui-colors-primary);font-size:12px;border-radius:0;border-width:1px;border-style:solid;background-color:transparent;padding-left:8px;padding-right:8px;padding-top:4px;padding-bottom:4px;margin-bottom:8px;margin-right:8px;color:#978fc9;border-color:#978fc9;}</style><div class="css-htrsmt">Fastify</div></div><style data-emotion="css 8g5rvv">.css-8g5rvv{font-family:Inconsolata,monospace;font-weight:700;font-size:18px;margin-top:0;margin-bottom:16px;color:var(--theme-ui-colors-primary);}.css-8g5rvv a{color:inherit;}.css-8g5rvv::before{content:'→';color:var(--theme-ui-colors-success);margin-right:8px;}.css-8g5rvv::after{content:'()';color:var(--theme-ui-colors-secondary);margin-left:4px;}</style><h2 class="css-8g5rvv"><style data-emotion="css t11yyu">.css-t11yyu{box-sizing:border-box;margin:0;min-width:0;color:var(--theme-ui-colors-muted);-webkit-transition:.2s linear box-shadow;transition:.2s linear box-shadow;}.css-t11yyu:focus{outline:none;box-shadow:0 2px 0 0 var(--theme-ui-colors-primary);}</style><a href="#the-results" class="css-t11yyu">First, the results</a></h2><style data-emotion="css 114bq9d">.css-114bq9d{margin-top:0;margin-bottom:16px;}.css-114bq9d code{font-family:monospace;color:inherit;background-color:var(--theme-ui-colors-surface);font-size:13px;padding:4px;}</style><p class="css-114bq9d">A journey on how I went from that amount of invocations in a voting system:</p><img style="width:100%" src="/images/posts/2022/12/08/lambda_v1.jpg" alt="The amount of invocations in v1." class="css-0"/><p class="css-114bq9d">For that number of invocations, making 2x as many requests as the v1 metrics, but processing only a fraction of them:</p><img style="width:100%" src="/images/posts/2022/12/08/lambda_v2.jpg" alt="The amount of invocations in v2." class="css-0"/><p class="css-114bq9d">If you don&#x27;t like reading images, don&#x27;t worry, I have a table:</p><style data-emotion="css 1x87fde">.css-1x87fde{border-collapse:collapse;margin-bottom:16px;border:none;}.css-1x87fde thead{background-color:#2f313f;}.css-1x87fde thead tr th{border:1px solid var(--theme-ui-colors-surface);padding:8px 16px;}.css-1x87fde thead td{color:#666;}.css-1x87fde tbody tr:nth-of-type(even){background-color:#2a2c39;}.css-1x87fde tbody tr td{padding:8px 16px;border:1px solid var(--theme-ui-colors-surface);}</style><table class="css-1x87fde"><thead><tr class="css-0"><style data-emotion="css xi606m">.css-xi606m{text-align:center;}</style><th class="css-xi606m">Version</th><th class="css-xi606m">Votes</th><th class="css-xi606m">Invocations (peak)</th><th class="css-xi606m">Lambda Concurrency (peak)</th></tr></thead><tbody><tr class="css-0"><td class="css-xi606m">v1</td><td class="css-xi606m">280k</td><td class="css-xi606m">1,51 million</td><td class="css-xi606m">200</td></tr><tr class="css-0"><td class="css-xi606m">v2</td><td class="css-xi606m">700k</td><td class="css-xi606m">1,6 thousand</td><td class="css-xi606m">11</td></tr></tbody></table><p class="css-114bq9d">Well, I can say that it&#x27;s definitly a blazing fast improvement, right?</p><img style="width:100%" src="/images/posts/2022/12/08/fast-blazing-fast.gif" alt="Brazing fast, as The Primegean says." class="css-0"/><h2 class="css-8g5rvv"><a href="#context" class="css-t11yyu">Ok, context please?</a></h2><p class="css-114bq9d">Okay, the following task came to me one Monday morning:</p><div style="background-color:#FFF;width:100%" class="css-0"><img style="width:100%" src="/images/posts/2022/12/08/context.png" alt="The conversation between me and my manager." class="css-0"/></div><p class="css-114bq9d">With these requirements, let&#x27;s present the first architecture I developed.</p><h2 class="css-8g5rvv"><a href="#v1-architecture" class="css-t11yyu">v1 Architecture</a></h2><p class="css-114bq9d">About the technologies, I chose:</p><style data-emotion="css ddqk15">.css-ddqk15{margin-top:0;margin-bottom:16px;padding-left:24px;list-style:square;}</style><ul class="css-ddqk15"><style data-emotion="css r6pclz">.css-r6pclz{margin-bottom:4px;}.css-r6pclz code{font-family:monospace;color:inherit;background-color:var(--theme-ui-colors-surface);font-size:13px;padding:4px;}</style><li class="css-r6pclz">NestJS with Fastify.<ul class="css-ddqk15"><li class="css-r6pclz">For performance, I leave as little middleware as possible, I even removed <code class="css-0">compression</code> and <code class="css-0">rate-limit</code> to not cost too much in performance.</li></ul></li><li class="css-r6pclz">Stateless JWTs to authenticate.<ul class="css-ddqk15"><li class="css-r6pclz">I usually prefer to hit the database on every request to check if the JWT is still valid, in this case I skip this part and keep the JWT expiry time as low as possible.</li></ul></li><li class="css-r6pclz"><code class="css-0">AWS Lambda</code> for hosting the code.<ul class="css-ddqk15"><li class="css-r6pclz">The advantage of using this guy is that I can only pay for usage, and the TV show only runs once a week, so this guy fits in really well.</li></ul></li><li class="css-r6pclz"><code class="css-0">AWS API Gateway HTTP</code> to expose <code class="css-0">AWS Lambda</code><ul class="css-ddqk15"><li class="css-r6pclz">Using <code class="css-0">HTTP</code> version instead of <code class="css-0">REST</code> makes me reduce costs, instead of paying $4 per million, I only pay $1.</li></ul></li><li class="css-r6pclz"><code class="css-0">AWS ElastiCache</code> to cache all data to reduce database workload on hot-paths.<ul class="css-ddqk15"><li class="css-r6pclz">I choose a cluster with 2 instances of 0.5GB, I won&#x27;t save much information but I need to have a high reading capacity.</li></ul></li><li class="css-r6pclz"><code class="css-0">AWS RDS Postgres</code> as the database service.<ul class="css-ddqk15"><li class="css-r6pclz">For this guy, I knew I wouldn&#x27;t use that much, so I just chose a T4g.small with 2vCPU with 2GB of RAM.</li></ul></li></ul><p class="css-114bq9d">The architecture looks like:</p><img style="width:100%" src="/images/posts/2022/12/08/v1_architecture.jpg" alt="The v1 architecture." class="css-0"/><style data-emotion="css 1dsdrie">.css-1dsdrie{border-radius:0;border-left-color:var(--theme-ui-colors-muted);border-left-style:solid;border-left-width:4px;margin-top:0;margin-left:8px;margin-bottom:16px;margin-right:0;}.css-1dsdrie p{padding:16px;margin-bottom:0;}</style><blockquote class="css-1dsdrie"><p class="css-114bq9d">Fun fact: It cost around $70 without any API calls.</p></blockquote><style data-emotion="css yb5pq">.css-yb5pq{font-family:Inconsolata,monospace;font-weight:700;font-size:18px;margin-top:0;margin-bottom:16px;color:var(--theme-ui-colors-secondary);}.css-yb5pq a{color:inherit;}</style><h3 class="css-yb5pq"><a href="#why-x-not-y" class="css-t11yyu">But wait, why didn&#x27;t you choose X over Y?</a></h3><p class="css-114bq9d">At this point, you might wonder why I didn&#x27;t use a NoSQL database, or host on <code class="css-0">AWS EC2</code>, or use another technology.</p><p class="css-114bq9d">My answer to this is just this: I had 2 weeks to build a system, test it and deploy it to be used by the TV show.</p><p class="css-114bq9d">Also, I&#x27;ll explain later, it makes almost no difference what technology I choose for the database, for hosting the API, the main bottlenecks of my application
not in those areas.</p><p class="css-114bq9d">Choose technologies that your team is comfortable with and you know, if you have more time you can explore and test new things but with little time,
go with technologies that you already deployed in production and those were the technologies that I was aware of at the time.</p><h2 class="css-8g5rvv"><a href="#hot-path" class="css-t11yyu">The hot path of V1</a></h2><p class="css-114bq9d"><code class="css-0">Hot Path</code> is the area of your code that is most accessed, in my case it was two routes:</p><h3 class="css-yb5pq"><a href="#get-polls" class="css-t11yyu">GET: <code class="css-0">/polls</code></a></h3><p class="css-114bq9d">This route returns current polls for users to see which singer is currently up for voting.</p><p class="css-114bq9d">To have better performance and not hit the database every time, I store this data inside the <code class="css-0">ElastiCache</code>,
so every time someone asks for the open polls, I return this data which has been cached for 3s until needs to get from the database.</p><p class="css-114bq9d">This cache was inside the <code class="css-0">AWS Lambda</code>, inside the <code class="css-0">NestJS</code> service that handles the request to obtain the polls.
Remember this information, I&#x27;ll talk about it again in the <code class="css-0">V2</code> architecture.</p><p class="css-114bq9d">Also, this route was called every 3s by users because we need to check if the poll is still available,
administrators can enable and disable them at will.</p><h3 class="css-yb5pq"><a href="#post-polls" class="css-t11yyu">POST: <code class="css-0">/polls/{pollId}/signers/{signerId}</code></a></h3><p class="css-114bq9d">In this route, users can select which singer they want. And since the user can call this route as many times as he wants,
this route is insanely called.</p><p class="css-114bq9d">To decrease the stress on the database, I only make 1 database call on this route, it&#x27;s the insert to save the vote.
To count the amount of votes, I leave that task to <code class="css-0">ElastiCache</code> and use this insanely well-designed library called <a href="https://github.com/mlomb/redis-rank" target="_blank" rel="noopener" class="css-t11yyu">redis-rank</a>.
With this library, I could easily rank each poll and input the votes one by one as it arrives.</p><p class="css-114bq9d">To check if the vote is valid, I cache the information in <code class="css-0">ElastiCache</code> and just look it up. With this strategy, I was able to save 2 database calls, one
for <code class="css-0">pollId</code> and another for <code class="css-0">signerId</code>.</p><blockquote class="css-1dsdrie"><p class="css-114bq9d">The downside to this strategy is that I have to create hooks in all the methods that change the poll and signer to update the cache.
An easier way to do this is by emitting an event for each change, so you just have to listen to the changes to be able to update the cache.</p></blockquote><p class="css-114bq9d">For the table that saves the votes, I didn&#x27;t use foreign keys because I didn&#x27;t want the database to do the work it already did of verifying that the information
its valid. Also, I chose this strategy for performance reasons, Adam Zolo has an article on <a href="https://blog.adamzolo.com/the-cost-of-postgresql-foreign-keys/" target="_blank" rel="noopener" class="css-t11yyu">The Cost of PostgreSQL Foreign Keys</a> if you are interested.
For this table, I left only an <code class="css-0">index</code> in <code class="css-0">pollId</code> so I can count and compare the votes once the poll is over to check if everything is in sync.</p><h2 class="css-8g5rvv"><a href="#v1-metrics" class="css-t11yyu">The metrics of V1</a></h2><p class="css-114bq9d">At this point I was really proud of what I was able to achieve because I deploy this solution and it worked really well.</p><p class="css-114bq9d">Now, let&#x27;s see the metrics of 280k votes performed by 12k users:</p><a class="css-t11yyu" href="/images/posts/2022/12/08/lambda_v1.png"><img style="width:100%" src="/images/posts/2022/12/08/lambda_v1.jpg" alt="The amount of invocations in v1." class="css-0"/></a><p class="css-114bq9d">In addition, I also have some database metrics:</p><a class="css-t11yyu" href="/images/posts/2022/12/08/cpu_v1.png"><img style="width:100%" src="/images/posts/2022/12/08/cpu_v1.png" alt="The database CPU usage." class="css-0"/></a><a class="css-t11yyu" href="/images/posts/2022/12/08/commits_v1.png"><img style="width:100%" src="/images/posts/2022/12/08/commits_v1.png" alt="The database commits." class="css-0"/></a><blockquote class="css-1dsdrie"><p class="css-114bq9d">Hint: Click on the image to open in higher resolution.</p></blockquote><p class="css-114bq9d">The system was very stressed, but it worked very well (no errors).
The CPU usage was high but it is scalable so it can pass 2 vCPU without any worries so this amount of usage is not an issue.</p><p class="css-114bq9d">The only thing I didn&#x27;t like is the amount of concurrency in lambdas and the amount of commits per second, the database was doing like 400 commits per second, it&#x27;s A LOT.</p><p class="css-114bq9d">The architecture wasn&#x27;t bad, but I wasn&#x27;t happy with those numbers, the system wasn&#x27;t scalable enough for me, so I started looking into other approaches to the same problem.</p><h2 class="css-8g5rvv"><a href="#optimal-number-of-lines" class="css-t11yyu">The optimal number of lines of code is zero</a></h2><p class="css-114bq9d">Maybe you&#x27;ve heard this phrase somewhere before, this phrase stuck in my head during my studies and then I started thinking of strange solutions.</p><p class="css-114bq9d">One such solution was: What if I cache GET: <code class="css-0">/polls</code> in <code class="css-0">AWS S3</code>? So the frontend just needs to grab the <code class="css-0">JSON</code> from the bucket, and every time I update the
database I just updated the <code class="css-0">JSON</code> in <code class="css-0">S3</code>, with this approach, I could reduce the amount of invocations to get the polls to zero, instantaneous, and it can handle an &quot;infinite&quot; amount of requests.</p><img style="width:100%" src="/images/posts/2022/12/08/mind-blown-shocked.gif" alt="Explosion mind" class="css-0"/><blockquote class="css-1dsdrie"><p class="css-114bq9d">My first reaction for this approach was exactly this gif.</p></blockquote><p class="css-114bq9d">But using the &#x27;AWS S3&#x27; solution looks pretty ugly, we&#x27;re engineers, there must be a &quot;better&quot; option.</p><p class="css-114bq9d">So I remember from <code class="css-0">AWS Cloudfront</code>, if we can cache files, we can cache API requests because the return of a request is just a text file with the format that the system knows, JSON.
We could use the <code class="css-0">max-age</code> and <code class="css-0">Cache-Control</code> headers to keep the data in <code class="css-0">AWS Cloudfront</code> for a few seconds until we need to make the request to my API.
With this setup only one request every 3s will ideally reach my API instead of all requests hitting the API the old fashioned way.</p><p class="css-114bq9d">I said ideally because cloudfare will cache on the edge, if two people in different parts of the globe make a request, we still need to make two requests because the servers
it will be different, and this is called <a href="https://www.youtube.com/watch?v=RY_2gElt3SA" target="_blank" rel="noopener" class="css-t11yyu">eventual consistency</a> and for what I was building this is not an issue.</p><p class="css-114bq9d">Okay, looks good, but what about the votes, another hot path from my code, what can I do with this guy? So I started thinking about that phrase again
and found a solution with <code class="css-0">AWS SQS</code> and <code class="css-0">AWS API Gateway HTTP</code>.</p><p class="css-114bq9d">Did you know that you can <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-aws-services.html" target="_blank" rel="noopener" class="css-t11yyu">expose an <code class="css-0">SQS</code> queue directly with <code class="css-0">Api Gateway</code></a>?
I didn&#x27;t know either, with this guy, essentially anyone can send an item into the queue.
For me this was perfect because it was exactly what I needed, but I had my API to handle it directly, so if I use this integration I can reduce the number of requests to zero
accessing my API to vote, not to process the votes, perfect!</p><p class="css-114bq9d">And with <code class="css-0">SQS Lambda Integration</code>, we can configure <code class="css-0">Batch Window</code>, which you can configure to <code class="css-0">AWS</code> to group the items in the queue until they reach X amount every Y seconds before calling something to process it.
In my case, I set it to process <code class="css-0">300</code> items in <code class="css-0">3s</code>, because I have A LOT of votes, we get more than that in <code class="css-0">1s</code> so <code class="css-0">3s</code> is very safe. Also, I couldn&#x27;t set more than <code class="css-0">300</code> because
the lambda didn&#x27;t support that amount of data, so <code class="css-0">300</code> was my limit.</p><p class="css-114bq9d">Another advantage of this queued solution, I can do a batch insert into the database, which is much faster than doing an insert for each item.
In the end, instead of writing an insert for every vote, I just write an insert for every <code class="css-0">300</code> votes.</p><p class="css-114bq9d">Finally, remember how I said that it doesn&#x27;t matter which database API technology I choose? That&#x27;s why, with this kind of caching and using queue and batch inserts,
it doesn&#x27;t matter if I do it with NoSQL, C#, C++, whatever the technology, because those improvements will only be a fraction of the total time saved by choosing
the right strategy for the job.</p><h2 class="css-8g5rvv"><a href="#v2-architecture" class="css-t11yyu">v2 Architecture</a></h2><p class="css-114bq9d">Okay, let&#x27;s summarize our new architecture:</p><p class="css-114bq9d">For <code class="css-0">/polls</code>: we will use <code class="css-0">AWS Cloudfront</code> in front of <code class="css-0">AWS API Gateway</code> and the API will return <code class="css-0">Cache-Control: s-max-age=3s</code> to cache the data for 3s until <code class="css-0">Cloudfront</code> needs it to access the API again.</p><p class="css-114bq9d">For <code class="css-0">/polls/{pollId}/signers/{signerId}</code>: Let&#x27;s change this route to <code class="css-0">/polls/signers/sqs</code> and configure within the <code class="css-0">API Gateway</code> to forward directly to the <code class="css-0">SQS</code> queue.
So every time someone sends a request to <code class="css-0">/polls/signers/sqs</code> it will call <code class="css-0">SQS</code> directly and not call my API.</p><p class="css-114bq9d">Then I configure <code class="css-0">SQS</code> to call my Lambda using <a href="https://serverless-adapter.viniciusl.com.br" target="_blank" rel="noopener" class="css-t11yyu">Serverless-adapter</a> and <a href="https://serverless-adapter.viniciusl.com.br/docs/main/adapters/aws/sqs" target="_blank" rel="noopener" class="css-t11yyu">SQS Adapter</a>,
which will turn the <code class="css-0">SQS event</code> into an <code class="css-0">HTTP Post request</code> to my API to allow us to keep the logic in the same codebase.
Within the code, we can use the same strategy of doing validations with <code class="css-0">ElastiCache</code> and in the end, just do a batch insert in the database.</p><p class="css-114bq9d">Now the architecture looks like this:</p><img style="width:100%" src="/images/posts/2022/12/08/v2_architecture.jpg" alt="The v2 architecture." class="css-0"/><h2 class="css-8g5rvv"><a href="#v2-metrics" class="css-t11yyu">The metrics of V2</a></h2><p class="css-114bq9d">Well, the most exciting part of doing some optimization is seeing the metrics, to check if they really helped.</p><p class="css-114bq9d">Let&#x27;s see the metrics for 700k votes in stress tests:</p><a class="css-t11yyu" href="/images/posts/2022/12/08/lambda_v2.png"><img style="width:100%" src="/images/posts/2022/12/08/lambda_v2.jpg" alt="The amount of invocations in v2." class="css-0"/></a><p class="css-114bq9d">And for the database, we have these metrics.</p><a class="css-t11yyu" href="/images/posts/2022/12/08/cpu_v2.png"><img style="width:100%" src="/images/posts/2022/12/08/cpu_v2.png" alt="The database CPU usage." class="css-0"/></a><a class="css-t11yyu" href="/images/posts/2022/12/08/commits_v2.png"><img style="width:100%" src="/images/posts/2022/12/08/commits_v2.png" alt="The database commits." class="css-0"/></a><blockquote class="css-1dsdrie"><p class="css-114bq9d">Hint: Click on the image to open in higher resolution.</p></blockquote><p class="css-114bq9d">To summarize:</p><table class="css-1x87fde"><thead><tr class="css-0"><th class="css-xi606m">Version</th><th class="css-xi606m">Num. of Votes</th><th class="css-xi606m">Invocations (peak)</th><th class="css-xi606m">Concurrency (peak)</th><th class="css-xi606m">Number of vCPU</th><th class="css-xi606m">CPU Usage (peak)</th><th class="css-xi606m">RDS Commits (peak)</th></tr></thead><tbody><tr class="css-0"><td class="css-xi606m">v1</td><td class="css-xi606m">280k</td><td class="css-xi606m">1,51 million</td><td class="css-xi606m">200</td><td class="css-xi606m">1,5</td><td class="css-xi606m">40%</td><td class="css-xi606m">400 commit/s</td></tr><tr class="css-0"><td class="css-xi606m">v2</td><td class="css-xi606m">700k</td><td class="css-xi606m">1,6 thousand</td><td class="css-xi606m">11</td><td class="css-xi606m">0,5</td><td class="css-xi606m">15%</td><td class="css-xi606m">15 commit/s</td></tr></tbody></table><h2 class="css-8g5rvv"><a href="#conclusion" class="css-t11yyu">Conclusion</a></h2><p class="css-114bq9d">I hope that with this article you can learn something about <code class="css-0">AWS Cloudfront</code>, <code class="css-0">AWS SQS</code> and <code class="css-0">AWS API Gateway</code>, about how correct caching can optimize your application and how Batch can be much more efficient than doing one thing at a time.</p><p class="css-114bq9d">Also, not just about technologies, I hope you&#x27;ve learned a little bit about the mindset of also looking for improvements to reduce costs, improve scalability and availability of the system you&#x27;re working on.
And most importantly, never be satisfied with something just because it works, everything could be improved, you just haven&#x27;t learned how to improve yet.</p><p class="css-114bq9d">Also, as a developer, always read the documentation for your company&#x27;s cloud services so you can identify improvements like these.
I&#x27;m not telling you to get the cloud certificate, but sometimes just read the documentation and see what they can do, do little experiments to see what advantages it can bring to a project you&#x27;re working on, in my case it reduced it a lot costs and greatly improved scalability.</p><p class="css-114bq9d">Lastly, a tip on how to use these services, monitor usage and put limits on your <code class="css-0">API Gateway</code>, scalable solutions are great until the bill comes (:</p><style data-emotion="css 15t1oa2">.css-15t1oa2{box-sizing:border-box;margin:0;min-width:0;color:gray;margin:0;margin-top:8px;margin-bottom:8px;border:0;border-bottom:1px solid;border:none;margin-top:0;margin-bottom:16px;}</style><hr class="css-15t1oa2"/><div style="background-color:#FFF;padding:1rem;border-radius:8px"><div id="disqus_thread"></div></div></main></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/2022/12/08-from-million-invocations-to-thousand-with-correct-caching/";window.___webpackCompilationHash="4a0041db362847c6c7a2";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-56fe042cf93575a4bf85.js"],"app":["/app-8b92cc2aa653b9b1b562.js"],"component---node-modules-pauliescanlon-gatsby-theme-terminal-src-pages-404-js":["/component---node-modules-pauliescanlon-gatsby-theme-terminal-src-pages-404-js-0cd08f1b27dfec91c6da.js"],"component---src-pages-index-mdx":["/component---src-pages-index-mdx-e47d6fbfdd6476bdaff3.js"],"component---src-pages-posts-mdx":["/component---src-pages-posts-mdx-0dfbf17057c5f23e5563.js"],"component---src-pages-projects-mdx":["/component---src-pages-projects-mdx-6978d4d7ac4b17b1aff4.js"],"component---src-pauliescanlon-gatsby-theme-terminal-layouts-source-layout-js":["/component---src-pauliescanlon-gatsby-theme-terminal-layouts-source-layout-js-d39d178ea30291001218.js"]};/*]]>*/</script><script src="/polyfill-56fe042cf93575a4bf85.js" nomodule=""></script><script src="/app-8b92cc2aa653b9b1b562.js" async=""></script><script src="/framework-d7896e92719d1848aaa2.js" async=""></script><script src="/webpack-runtime-1d946749f45b5ec13753.js" async=""></script></body></html>